@using System.Linq
@using OpsReady.Models
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

@if (events == null)
{
    <p>Loading...</p>
}
else if (!events.Any())
{
    <p>No training events found.</p>
}
else
{
    <div class="mb-3 d-flex gap-2 flex-wrap">
        <input class="form-control w-auto" placeholder="Search..." @bind="SearchText" />

        <select class="form-select w-auto" @bind="SelectedSort">
            <option value="Title">Title</option>
            <option value="StartDate">Start Date</option>
            <option value="EndDate">End Date</option>
            <option value="Instructor">Instructor</option>
            <option value="Location">Location</option>
            <option value="Provider">Provider</option>
            <option value="DurationHours">Duration (hrs)</option>
            <option value="Status">Status</option>
        </select>

        <select class="form-select w-auto" @bind="TrainingTypeFilter">
            <option value="">All Types</option>
            @foreach (var t in DistinctTrainingTypes)
            {
                <option value="@t">@t</option>
            }
        </select>

        <select class="form-select w-auto" @bind="StatusFilter">
            <option value="">All Status</option>
            @foreach (var s in DistinctStatuses)
            {
                <option value="@s">@s</option>
            }
        </select>

        <select class="form-select w-auto" @bind="ProviderFilter">
            <option value="">All Providers</option>
            @foreach (var p in DistinctProviders)
            {
                <option value="@p">@p</option>
            }
        </select>

        <div class="d-flex gap-1 align-items-center">
            <label class="m-0 small">From</label>
            <InputDate class="form-control" @bind-Value="StartDateFilter" />
        </div>

        <div class="d-flex gap-1 align-items-center">
            <label class="m-0 small">To</label>
            <InputDate class="form-control" @bind-Value="EndDateFilter" />
        </div>

        <div class="d-flex gap-1 align-items-center">
            <label class="m-0 small">Page size</label>
            <InputNumber class="form-control w-25" @bind-Value="PageSize" />
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Start</th>
                    <th>Deadline</th>
                    <th>Location</th>
                    <th>Provider</th>
                    <th>Hours</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ev in FilteredSortedEvents.Skip((CurrentPage - 1) * PageSize).Take(PageSize))
                {
                    <tr>
                        <td>@ev.Id</td>
                        <td>@ev.Title</td>
                        <td>@ev.TrainingType</td>
                        <td>@ev.TrainingCategory</td>                 
                        <td>@(ev.StartDate.ToString("yyyy-MM-dd"))</td>
                        <td>@(ev.EnrollmentDeadline.ToString("yyyy-MM-dd"))</td>
                        <td>@ev.Location</td>
                        <td>@ev.Provider</td>
                        <td>@ev.DurationHours</td>
                        
                        <td>
                            <div class="btn-group" role="group">
                                <!-- Link to TrainingEventPage, passing the event id in the route -->
                                <a class="btn btn-primary btn-sm" href="@($"/training/event/{ev.Id}")">View</a>
                                <!-- Assign button placeholder (link/action can be updated later) -->
                                <a class="btn btn-secondary btn-sm" href="@($"/training/assign/{ev.Id}")">Assign</a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
            Showing @((CurrentPage - 1) * PageSize + 1) - @Math.Min(CurrentPage * PageSize, FilteredSortedEvents.Count()) of @FilteredSortedEvents.Count()
        </div>
        <div>
            <button class="btn btn-secondary btn-sm" @onclick="PreviousPage" disabled="@(CurrentPage == 1)">Previous</button>
            @for (int i = 1; i <= TotalPages; i++)
            {
                var pageNumber = i;
                <button class="btn btn-sm @(CurrentPage == pageNumber ? "btn-primary" : "btn-outline-secondary") mx-1" @onclick="() => GoToPage(pageNumber)">@pageNumber</button>
            }
            <button class="btn btn-secondary btn-sm" @onclick="NextPage" disabled="@(CurrentPage == TotalPages)">Next</button>
        </div>
    </div>
}

@code {
    private List<TrainingEvent> events = new();
    private string SearchText { get; set; } = string.Empty;
    private string SelectedSort { get; set; } = "Title";

    // filters
    private string TrainingTypeFilter { get; set; } = string.Empty;
    private string StatusFilter { get; set; } = string.Empty;
    private string ProviderFilter { get; set; } = string.Empty;
    private DateTime? StartDateFilter { get; set; }
    private DateTime? EndDateFilter { get; set; }

    // pagination
    private int CurrentPage { get; set; } = 1;
    private int PageSize { get; set; } = 10;
    private int TotalPages => Math.Max(1, (int)Math.Ceiling((double)FilteredSortedEvents.Count() / PageSize));

    // status (deletion handled elsewhere)
    protected override async Task OnInitializedAsync()
    {
        try
        {
            events = await HttpClient.GetFromJsonAsync<List<TrainingEvent>>("api/trainingevent") ?? new List<TrainingEvent>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to load training events: {ex.Message}");
            events = new List<TrainingEvent>();
        }
    }

    private IEnumerable<string> DistinctTrainingTypes => events.Select(e => e.TrainingType).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().OrderBy(s => s);
    private IEnumerable<string> DistinctStatuses => events.Select(e => e.Status).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().OrderBy(s => s);
    private IEnumerable<string> DistinctProviders => events.Select(e => e.Provider).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().OrderBy(s => s);

    private IEnumerable<TrainingEvent> FilteredSortedEvents
    {
        get
        {
            var query = events.AsEnumerable();

            // search across common text fields
            if (!string.IsNullOrWhiteSpace(SearchText))
            {
                query = query.Where(e =>
                    (e.Title ?? string.Empty).Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    (e.Description ?? string.Empty).Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    (e.Instructor ?? string.Empty).Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    (e.Location ?? string.Empty).Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    (e.Provider ?? string.Empty).Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    (e.Status ?? string.Empty).Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    (e.TrainingType ?? string.Empty).Contains(SearchText, StringComparison.OrdinalIgnoreCase)
                );
            }

            // filters
            if (!string.IsNullOrWhiteSpace(TrainingTypeFilter))
                query = query.Where(e => string.Equals(e.TrainingType, TrainingTypeFilter, StringComparison.OrdinalIgnoreCase));

            if (!string.IsNullOrWhiteSpace(StatusFilter))
                query = query.Where(e => string.Equals(e.Status, StatusFilter, StringComparison.OrdinalIgnoreCase));

            if (!string.IsNullOrWhiteSpace(ProviderFilter))
                query = query.Where(e => string.Equals(e.Provider, ProviderFilter, StringComparison.OrdinalIgnoreCase));

            if (StartDateFilter.HasValue)
                query = query.Where(e => e.StartDate >= StartDateFilter.Value);

            if (EndDateFilter.HasValue)
                query = query.Where(e => e.EndDate <= EndDateFilter.Value);

            // sorting
            query = SelectedSort switch
            {
                "StartDate" => query.OrderBy(e => e.StartDate),
                "EndDate" => query.OrderBy(e => e.EndDate),
                "Instructor" => query.OrderBy(e => e.Instructor),
                "Location" => query.OrderBy(e => e.Location),
                "Provider" => query.OrderBy(e => e.Provider),
                "DurationHours" => query.OrderBy(e => e.DurationHours),
                "Status" => query.OrderBy(e => e.Status),
                _ => query.OrderBy(e => e.Title)
            };

            return query;
        }
    }

    private void HandleFilterChanged()
    {
        CurrentPage = 1;
    }

    private void GoToPage(int page)
    {
        CurrentPage = page;
    }

    private void PreviousPage()
    {
        if (CurrentPage > 1) CurrentPage--;
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages) CurrentPage++;
    }

    // Placeholder action for the new Assign button. Update the navigation or handler when ready.
    private void AssignEvent(int id)
    {
        // default placeholder route — you can change this to the final link later
        NavigationManager.NavigateTo($"/training/assign/{id}");
    }
}
