@using System.Text.Json
@using OpsReadyUI.Models

@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

@if (profile == null)
{
    <p><em>Loading profile...</em></p>
}
else
{
    <div class="card userprofile-card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <strong>Edit Profile</strong>
                <div class="text-muted small">Manage user profile details</div>
            </div>
            <div>
                <button class="btn btn-outline-secondary btn-sm" @onclick="@(() => NavigationManager.NavigateTo("/"))">Back</button>
            </div>
        </div>

        <EditForm Model="profile" OnValidSubmit="SaveProfile" class="card-body">
            <DataAnnotationsValidator />
            <ValidationSummary />

            @* Hidden bindings for Id and UserId *@
            <input type="hidden" @bind="profile.Id" />
            <input type="hidden" @bind="profile.UserId" />

            <div class="row gx-3">
                <div class="col-md-6 mb-3">
                    <label for="firstName">First name</label>
                    <InputText id="firstName" class="form-control" @bind-Value="profile.FirstName" placeholder="Given name" />
                    <ValidationMessage For="@(() => profile.FirstName)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="lastName">Last name</label>
                    <InputText id="lastName" class="form-control" @bind-Value="profile.LastName" placeholder="Family name" />
                    <ValidationMessage For="@(() => profile.LastName)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="preferredName">Preferred name</label>
                    <InputText id="preferredName" class="form-control" @bind-Value="profile.PreferredName" />
                    <ValidationMessage For="@(() => profile.PreferredName)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="badgeNumber">Badge number</label>
                    <InputText id="badgeNumber" class="form-control" @bind-Value="profile.BadgeNumber" />
                    <ValidationMessage For="@(() => profile.BadgeNumber)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="position">Position</label>
                    <InputText id="position" class="form-control" @bind-Value="profile.Position" />
                    <ValidationMessage For="@(() => profile.Position)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="rank">Rank</label>
                    <InputText id="rank" class="form-control" @bind-Value="profile.Rank" />
                    <ValidationMessage For="@(() => profile.Rank)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="department">Department</label>
                    <InputText id="department" class="form-control" @bind-Value="profile.Department" />
                    <ValidationMessage For="@(() => profile.Department)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="location">Location</label>
                    <InputText id="location" class="form-control" @bind-Value="profile.Location" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="stationLocation">Station location</label>
                    <InputText id="stationLocation" class="form-control" @bind-Value="profile.StationLocation" />
                    <ValidationMessage For="@(() => profile.StationLocation)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="phone">Phone</label>
                    <InputText id="phone" class="form-control" @bind-Value="profile.PhoneNumber" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="email">Email</label>
                    <InputText id="email" class="form-control" @bind-Value="profile.EmailAddress" />
                    <ValidationMessage For="@(() => profile.EmailAddress)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="dob">Date of birth</label>
                    <InputDate id="dob" class="form-control" @bind-Value="profile.DateOfBirth" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="hire">Date of hire</label>
                    <InputDate id="hire" class="form-control" @bind-Value="profile.DateOfHire" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="gender">Gender</label>
                    <InputText id="gender" class="form-control" @bind-Value="profile.Gender" />
                    <ValidationMessage For="@(() => profile.Gender)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="ethnicity">Ethnicity</label>
                    <InputText id="ethnicity" class="form-control" @bind-Value="profile.Ethnicity" />
                    <ValidationMessage For="@(() => profile.Ethnicity)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="shiftSchedule">Shift schedule</label>
                    <InputText id="shiftSchedule" class="form-control" @bind-Value="profile.ShiftSchedule" />
                    <ValidationMessage For="@(() => profile.ShiftSchedule)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="supervisorBadge">Supervisor badge</label>
                    <InputText id="supervisorBadge" class="form-control" @bind-Value="profile.SupervisorBadgeNumber" />
                    <ValidationMessage For="@(() => profile.SupervisorBadgeNumber)" />
                </div>

                <div class="col-12 mb-3">
                    <label for="address1">Address 1</label>
                    <InputText id="address1" class="form-control" @bind-Value="profile.Address1" />
                </div>

                <div class="col-12 mb-3">
                    <label for="address2">Address 2</label>
                    <InputText id="address2" class="form-control" @bind-Value="profile.Address2" />
                </div>

                <div class="col-md-4 mb-3">
                    <label for="city">City</label>
                    <InputText id="city" class="form-control" @bind-Value="profile.City" />
                </div>

                <div class="col-md-4 mb-3">
                    <label for="state">State</label>
                    <InputText id="state" class="form-control" @bind-Value="profile.State" />
                </div>

                <div class="col-md-4 mb-3">
                    <label for="zip">Zip</label>
                    <InputText id="zip" class="form-control" @bind-Value="profile.ZipCode" />
                </div>

                <div class="col-12 mb-3">
                    <label for="skills">Skills</label>
                    <InputText id="skills" class="form-control" @bind-Value="profile.Skills" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="status">Status</label>
                    <InputText id="status" class="form-control" @bind-Value="profile.Status" />
                </div>

                <div class="col-md-6 mb-3 form-check align-items-center d-flex">
                    <InputCheckbox id="activeDuty" class="form-check-input me-2" @bind-Value="profile.IsActiveDuty" />
                    <label for="activeDuty" class="form-check-label mb-0">Active duty</label>
                </div>

                <div class="col-12 mb-3">
                    <label for="bio">Bio</label>
                    <InputTextArea id="bio" class="form-control" rows="4" @bind-Value="profile.Bio" />
                </div>

                <div class="col-12 mb-3">
                    <label for="legalRestrictions">Legal restrictions</label>
                    <InputTextArea id="legalRestrictions" class="form-control" rows="3" @bind-Value="profile.LegalRestrictions" />
                </div>

                <div class="col-12 mb-3">
                    <label for="exemptionsGranted">Exemptions granted</label>
                    <InputTextArea id="exemptionsGranted" class="form-control" rows="3" @bind-Value="profile.ExemptionsGranted" />
                </div>

                <div class="col-12 mb-3">
                    <label for="disciplinaryActions">Disciplinary actions</label>
                    <InputTextArea id="disciplinaryActions" class="form-control" rows="3" @bind-Value="profile.DisciplinaryActions" />
                </div>

                <div class="col-12 mb-3">
                    <label for="useOfForceClearance">Use of force clearance</label>
                    <InputTextArea id="useOfForceClearance" class="form-control" rows="2" @bind-Value="profile.UseOfForceClearance" />
                </div>

                <div class="col-12 mb-3">
                    <label for="languageFluency">Language fluency</label>
                    <InputText id="languageFluency" class="form-control" @bind-Value="profile.LanguageFluency" />
                </div>

                <div class="col-12 mb-3">
                    <label for="specialClearances">Special clearances</label>
                    <InputText id="specialClearances" class="form-control" @bind-Value="profile.SpecialClearances" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="commandingOfficer">Commanding officer badge</label>
                    <InputText id="commandingOfficer" class="form-control" @bind-Value="profile.CommandingOfficerBadgeNumber" />
                    <ValidationMessage For="@(() => profile.CommandingOfficerBadgeNumber)" />
                </div>

                <div class="col-12 mb-3">
                    <label for="notes">Notes</label>
                    <InputTextArea id="notes" class="form-control" rows="3" @bind-Value="profile.Notes" />
                </div>

                <div class="col-md-6 mb-3">
                    <label>Record Created By</label>
                    <InputText class="form-control" @bind-Value="profile.RecordCreatedBy" disabled />
                </div>

                <div class="col-md-6 mb-3">
                    <label>Record Created Date</label>
                    <InputDate class="form-control" @bind-Value="profile.RecordCreatedDate" disabled />
                </div>

                <div class="col-md-6 mb-3">
                    <label>Record Updated By</label>
                    <InputText class="form-control" @bind-Value="profile.RecordUpdatedBy" disabled />
                </div>

                <div class="col-md-6 mb-3">
                    <label>Record Updated Date</label>
                    <InputDate class="form-control" @bind-Value="profile.RecordUpdatedDate" disabled />
                </div>
            </div>  

            <div class="card-footer d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" @onclick="@(() => NavigationManager.NavigateTo("/"))">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="DeleteProfile">Delete</button>
                @* submit will trigger OnValidSubmit -> SaveProfile which will POST when profile.Id == 0, otherwise PUT *@
                <button type="submit" class="btn btn-success">Save</button>
            </div>
        </EditForm>

        @* Status alert below the action buttons *@
        @if (!string.IsNullOrWhiteSpace(statusMessage))
        {
            <div class="@statusAlertClass mt-3 mx-3 p-3" role="alert">
                <div>@(statusMessage)</div>
                <button type="button" class="btn-close float-end" aria-label="Close" @onclick="ClearStatus"></button>
            </div>
        }
    </div>
}
@code {
    [Parameter] public int userId { get; set; }
    private UserProfile? profile;

    // status message shown to user after operations
    private string? statusMessage;
    private string statusAlertClass = "alert alert-success";
    private System.Threading.CancellationTokenSource? statusCts;

    protected override async Task OnInitializedAsync()
    {
        UserProfile? serverProfile = null;

        try
        {
            serverProfile = await HttpClient.GetFromJsonAsync<UserProfile>($"api/userprofile/{userId}");
        }
        catch (HttpRequestException)
        {
            serverProfile = null;
        }

        if (!IsServerProfileValid(serverProfile))
        {
            // Do not create or POST a new record on initialization.
            // Prepare a local empty profile -- save will POST if user submits.
            profile = new UserProfile
            {
                Id = 0,
                UserId = userId,
                RecordCreatedBy = "system",
                RecordCreatedDate = DateTime.UtcNow,
                RecordUpdatedBy = "system",
                RecordUpdatedDate = DateTime.UtcNow
            };
        }
        else
        {
            profile = serverProfile;
        }
    }

    private static bool IsServerProfileValid(UserProfile? p)
    {
        return p is not null && p.UserId != 0;
    }

    private async Task SaveProfile()
    {
        if (profile is null)
            return;

        // update audit timestamp and ensure non-null audit strings
        profile.RecordUpdatedDate = DateTime.UtcNow;
        profile.RecordUpdatedBy = string.IsNullOrWhiteSpace(profile.RecordUpdatedBy) ? "system" : profile.RecordUpdatedBy;

        try
        {
            if (profile.Id == 0)
            {
                // create new record (POST) only when user presses Save and Id == 0
                var postResponse = await HttpClient.PostAsJsonAsync("api/userprofile", profile);

                if (postResponse.IsSuccessStatusCode)
                {
                    var created = await postResponse.Content.ReadFromJsonAsync<UserProfile>();
                    if (created is not null)
                    {
                        profile = created;
                        ShowStatus("Profile created successfully.", "alert alert-success");
                    }
                }
                else
                {
                    var err = await postResponse.Content.ReadAsStringAsync();
                    ShowStatus($"POST failed: {(int)postResponse.StatusCode} {postResponse.ReasonPhrase} - {err}", "alert alert-danger");
                    throw new HttpRequestException($"POST api/userprofile failed: {(int)postResponse.StatusCode} {postResponse.ReasonPhrase} - {err}");
                }
            }
            else
            {
                // update existing record (PUT)
                var putResponse = await HttpClient.PutAsJsonAsync($"api/userprofile", profile);

                if (putResponse.IsSuccessStatusCode)
                {
                    // optionally update local object if server returns the updated entity
                    if (putResponse.Content != null && putResponse.Content.Headers.ContentLength > 0)
                    {
                        var updated = await putResponse.Content.ReadFromJsonAsync<UserProfile>();
                        if (updated is not null)
                        {
                            profile = updated;
                        }
                    }

                    ShowStatus("Profile updated successfully.", "alert alert-success");
                }
                else
                {
                    var err = await putResponse.Content.ReadAsStringAsync();
                    ShowStatus($"PUT failed: {(int)putResponse.StatusCode} {putResponse.ReasonPhrase} - {err}", "alert alert-danger");
                    throw new HttpRequestException($"PUT api/userprofile failed: {(int)putResponse.StatusCode} {putResponse.ReasonPhrase} - {err}");
                }
            }
        }
        catch (Exception ex)
        {
            // Minimal error handling: show an error to the user and write to console during development.
            ShowStatus($"Error: {ex.Message}", "alert alert-danger");
            Console.Error.WriteLine(ex);
            throw;
        }
    }

    private async Task DeleteProfile()
    {
        if (profile!.Id != 0)
        {
            await HttpClient.DeleteAsync($"api/userprofile/{profile.Id}");
            profile = null;
        }
    }

    private void ShowStatus(string message, string alertClass = "alert alert-success", int autoHideMs = 4000)
    {
        statusCts?.Cancel();
        statusMessage = message;
        statusAlertClass = alertClass;
        StateHasChanged();

        if (autoHideMs > 0)
        {
            var cts = new System.Threading.CancellationTokenSource();
            statusCts = cts;
            _ = Task.Run(async () =>
            {
                try
                {
                    await Task.Delay(autoHideMs, cts.Token);
                    statusMessage = null;
                    await InvokeAsync(StateHasChanged);
                }
                catch (TaskCanceledException) { }
            });
        }
    }

    private void ClearStatus()
    {
        statusCts?.Cancel();
        statusMessage = null;
        StateHasChanged();
    }
}
